<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <style>
        :root {
            --soma-dark: #2d3436;
            --soma-beige: #e8d8c3;
            --soma-matcha: #cfd8bd; 
            --soma-absent: #e7c9c9; 
            --soma-extra: #b2bec3;  
            --soma-white: #ffffff;
            --soma-night: #1e272e;
            --bloc1: #d1d8c5; --bloc2: #c5d1d8; --bloc3: #d8cfc5; --bloc4: #d1d1d1; --bloc5: #d8c5c5;
            --current-bg: var(--soma-white);
            --current-header: var(--soma-beige);
            --current-text: var(--soma-dark);
            --card-bg: #ffffff;
        }

        /* CONFIGURATION SPÉCIALE NOTION : On enlève tout scroll interne */
        html, body { 
            margin: 0; 
            padding: 10px; 
            overflow: visible !important; /* Force Notion à voir toute la hauteur */
            height: auto !important;
            font-family: 'Inter', sans-serif;
            background-color: var(--current-bg);
            color: var(--current-text);
        }

        /* Les contrôles ne doivent plus être "fixed" (bloqués) mais suivre le mouvement */
        .controls { 
            display: flex; 
            justify-content: flex-end;
            gap: 10px; 
            margin-bottom: 20px;
        }

        .theme-btn { width: 22px; height: 22px; border-radius: 50%; border: 1px solid #ddd; cursor: pointer; }
        .reset-btn { background: #ff7675; color: white; border: none; padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 10px; font-weight: bold; }
        .print-btn { background: #dfe6e9; border: none; padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 10px; font-weight: bold; }

        .notebook-header { width: 100%; height: 100px; background-color: var(--current-header); border-radius: 15px; display: flex; align-items: center; justify-content: center; position: relative; margin-bottom: 20px;}
        .profile-container { position: absolute; left: 20px; width: 70px; height: 70px; border-radius: 50%; background: #f0f0f0; border: 3px solid white; overflow: hidden; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .profile-container img { width: 100%; height: 100%; object-fit: cover; }
        .header-text { letter-spacing: 5px; text-transform: uppercase; font-weight: bold; font-size: 18px; }

        .location-section { display: flex; flex-direction: column; align-items: center; gap: 8px; margin-bottom: 30px; }
        .location-input { border: none; border-bottom: 1px solid #ddd; width: 80%; text-align: center; padding: 5px; background: transparent; color: inherit; font-size: 12px;}

        .section-card { background: var(--card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); }
        
        .dashboard-grid { display: grid; grid-template-columns: 150px 1fr; gap: 20px; align-items: center; }
        .circular-progress { width: 130px; height: 130px; border-radius: 50%; background: conic-gradient(#eee 0deg); display: flex; align-items: center; justify-content: center; position: relative; }
        .circular-progress::before { content: ""; position: absolute; width: 100px; height: 100px; background: var(--card-bg); border-radius: 50%; }
        .percent-text { position: relative; font-size: 22px; font-weight: bold; }

        h2 { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 15px; border-left: 3px solid var(--soma-dark); padding-left: 10px; opacity: 0.8; }

        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { text-align: left; padding: 10px; border-bottom: 2px solid var(--soma-dark); }
        td { padding: 10px; border-bottom: 1px solid #f0f0f0; }

        .comp-line { display: grid; grid-template-columns: 1fr 100px; background: white; padding: 10px; border-bottom: 1px solid #f0f0f0; align-items: center; font-size: 11px; }
        .comp-date { font-family: monospace; font-size: 10px; text-align: center; padding: 4px; border-radius: 4px; background: #f8f9fa; border: 1px dashed #ccc; }

        .btn-add { background: var(--soma-dark); color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 10px; width: 100%; }
        textarea, input, select { background: rgba(0,0,0,0.02); border: 1px solid #ddd; padding: 8px; border-radius: 6px; font-size: 11px; color: inherit; }

        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

    <div class="controls no-print">
        <button class="reset-btn" onclick="resetAll()">RESET</button>
        <div class="theme-btn" style="background:white" onclick="setTheme('day')"></div>
        <div class="theme-btn" style="background:var(--soma-beige)" onclick="setTheme('soma')"></div>
        <div class="theme-btn" style="background:var(--soma-night)" onclick="setTheme('night')"></div>
        <button class="print-btn" onclick="window.print()">PDF</button>
    </div>

    <div class="notebook-header">
        <div class="profile-container" onclick="document.getElementById('fileInput').click()">
            <img id="profilePic" src="" style="display:none;">
            <span id="picPlaceholder" style="font-size:10px;">PHOTO</span>
        </div>
        <input type="file" id="fileInput" style="display:none;" accept="image/*" onchange="loadPhoto(event)">
        <div class="header-text">SUIVI SŌMA</div>
    </div>

    <div class="location-section">
        <input type="text" id="stageName" class="location-input" placeholder="NOM DE L'ÉTABLISSEMENT" oninput="saveData()">
        <input type="text" id="stageAddress" class="location-input" placeholder="ADRESSE COMPLÈTE" oninput="saveData()">
    </div>

    <div class="section-card dashboard-grid">
        <div class="circular-progress" id="circle"><div class="percent-text" id="percentValue">0%</div></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <div style="background:rgba(0,0,0,0.03); padding:5px; border-radius:5px;">
                <label style="font-size:8px; display:block;">QUOTA</label>
                <input type="number" id="quota" value="140" style="width:40px; padding:2px;"> <button onclick="calculate();saveData()" style="font-size:8px;">OK</button>
            </div>
            <div style="background:rgba(0,0,0,0.03); padding:5px; border-radius:5px;">
                <label style="font-size:8px; display:block;">PRÉSENCE</label>
                <input type="number" id="in_present" style="width:40px; padding:2px;"> <button onclick="addVal('present')" style="font-size:8px;">+</button>
            </div>
            <div style="background:rgba(0,0,0,0.03); padding:5px; border-radius:5px;">
                <label style="font-size:8px; display:block;">ABSENCE</label>
                <input type="number" id="in_absent" style="width:40px; padding:2px;"> <button onclick="addVal('absent')" style="font-size:8px;">-</button>
            </div>
            <div style="background:rgba(0,0,0,0.03); padding:5px; border-radius:5px;">
                <label style="font-size:8px; display:block;">SUPP</label>
                <input type="number" id="in_extra" style="width:40px; padding:2px;"> <button onclick="addVal('extra')" style="font-size:8px;">+</button>
            </div>
            <input type="hidden" id="present" value="0"><input type="hidden" id="absent" value="0"><input type="hidden" id="extra" value="0">
            <div id="alertBox" style="grid-column: span 2; font-size:9px; text-align:center; font-weight:bold;"></div>
        </div>
    </div>

    <div class="section-card no-print">
        <h2>Saisie Bilan</h2>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <select id="typeBilan"><option>Bilan Quotidien</option><option>Bilan Mi-Période</option><option>Bilan Fin de Période</option></select>
            <textarea id="texteBilan" placeholder="Observations..."></textarea>
            <button class="btn-add" onclick="validerBilan()">VALIDER LE BILAN</button>
        </div>
    </div>

    <div class="section-card">
        <h2>Bilans passés</h2>
        <table id="bilanTable">
            <tbody id="bilanBody"></tbody>
        </table>
    </div>

    <div class="section-card no-print">
        <h2>Validation Soins</h2>
        <div style="display: grid; gap: 10px;">
            <input type="date" id="newDate">
            <input type="text" id="newSoin" placeholder="Soin / Acte">
            <select id="newComp">
                <option value="">-- Compétence --</option>
                <option value="c1">C1 - Actes essentiels</option><option value="c1bis">C1bis - Éveil</option><option value="c2">C2 - Risques</option>
                <option value="c3">C3 - État clinique</option><option value="c4">C4 - Soins</option><option value="c5">C5 - Mobilisation</option>
                <option value="c6">C6 - Communication</option><option value="c7">C7 - Formation</option><option value="c8">C8 - Entretien</option>
                <option value="c9">C9 - Anomalies</option><option value="c10">C10 - Transmissions</option><option value="c11">C11 - Organisation</option>
            </select>
            <button class="btn-add" onclick="processValidation()">✓ VALIDER LE SOIN</button>
        </div>
    </div>

    <div class="section-card">
        <h2>Compétences Validées</h2>
        <div id="comp-list">
            <div class="comp-line"><span>C1 - Actes essentiels</span><div class="comp-date" id="date-c1">-</div></div>
            <div class="comp-line"><span>C1bis - Activités éveil</span><div class="comp-date" id="date-c1bis">-</div></div>
            <div class="comp-line"><span>C2 - Situations risque</span><div class="comp-date" id="date-c2">-</div></div>
            <div class="comp-line"><span>C3 - État clinique</span><div class="comp-date" id="date-c3">-</div></div>
            <div class="comp-line"><span>C4 - Soins adaptés</span><div class="comp-date" id="date-c4">-</div></div>
            <div class="comp-line"><span>C5 - Mobilisation</span><div class="comp-date" id="date-c5">-</div></div>
            <div class="comp-line"><span>C6 - Communication</span><div class="comp-date" id="date-c6">-</div></div>
            <div class="comp-line"><span>C7 - Informer pairs</span><div class="comp-date" id="date-c7">-</div></div>
            <div class="comp-line"><span>C8 - Entretien locaux</span><div class="comp-date" id="date-c8">-</div></div>
            <div class="comp-line"><span>C9 - Anomalies</span><div class="comp-date" id="date-c9">-</div></div>
            <div class="comp-line"><span>C10 - Transmissions</span><div class="comp-date" id="date-c10">-</div></div>
            <div class="comp-line"><span>C11 - Organisation</span><div class="comp-date" id="date-c11">-</div></div>
        </div>
    </div>

    <div class="soma-copyright">
        <p>© 2026 MÉTHODE SŌMA</p>
    </div>

    <script>
        function saveData() {
            const data = {
                stageName: document.getElementById('stageName').value,
                stageAddress: document.getElementById('stageAddress').value,
                quota: document.getElementById('quota').value,
                present: document.getElementById('present').value,
                absent: document.getElementById('absent').value,
                extra: document.getElementById('extra').value,
                bilanHtml: document.getElementById('bilanBody').innerHTML,
                profileImg: document.getElementById('profilePic').src,
                compDates: {}
            };
            document.querySelectorAll('.comp-date').forEach(el => {
                data.compDates[el.id] = { text: el.innerText, bg: el.style.background };
            });
            localStorage.setItem('soma_notion_data', JSON.stringify(data));
        }

        function loadData() {
            const saved = localStorage.getItem('soma_notion_data');
            if (!saved) return;
            const data = JSON.parse(saved);
            document.getElementById('stageName').value = data.stageName || "";
            document.getElementById('stageAddress').value = data.stageAddress || "";
            document.getElementById('quota').value = data.quota || 140;
            document.getElementById('present').value = data.present || 0;
            document.getElementById('absent').value = data.absent || 0;
            document.getElementById('extra').value = data.extra || 0;
            document.getElementById('bilanBody').innerHTML = data.bilanHtml || "";
            if(data.profileImg && data.profileImg.includes('base64')) {
                const img = document.getElementById('profilePic');
                img.src = data.profileImg; img.style.display = 'block';
                document.getElementById('picPlaceholder').style.display='none';
            }
            for (let id in data.compDates) {
                const el = document.getElementById(id);
                if(el) {
                    el.innerText = data.compDates[id].text;
                    el.style.background = data.compDates[id].bg;
                }
            }
            calculate();
        }

        function setTheme(m) {
            const r = document.documentElement;
            r.style.setProperty('--current-bg', m==='night'?'#1e272e':(m==='soma'?'#e8d8c3':'white'));
            r.style.setProperty('--current-text', m==='night'?'#f1f2f6':'#2d3436');
            r.style.setProperty('--card-bg', m==='night'?'#2c3e50':'white');
        }

        function addVal(type) {
            const val = parseFloat(document.getElementById('in_'+type).value) || 0;
            document.getElementById(type).value = parseFloat(document.getElementById(type).value) + val;
            document.getElementById('in_'+type).value = "";
            calculate(); saveData();
        }

        function calculate() {
            const q = parseFloat(document.getElementById('quota').value) || 1;
            const p = parseFloat(document.getElementById('present').value) || 0;
            const a = parseFloat(document.getElementById('absent').value) || 0;
            const e = parseFloat(document.getElementById('extra').value) || 0;
            const net = (p + e) - a;
            const pDeg = (p / q) * 360;
            document.getElementById('circle').style.background = `conic-gradient(var(--soma-matcha) 0deg ${pDeg}deg, #eee 0deg)`;
            document.getElementById('percentValue').innerHTML = Math.round((net / q) * 100) + "%";
            document.getElementById('alertBox').innerHTML = net >= q ? "QUOTA ATTEINT ✓" : `RESTE : ${q - net}H`;
        }

        function validerBilan() {
            const t = document.getElementById('texteBilan').value;
            if(!t) return;
            const row = document.getElementById('bilanBody').insertRow(0);
            row.innerHTML = `<td style="width:70px">${new Date().toLocaleDateString('fr-FR')}</td><td><b>${document.getElementById('typeBilan').value}</b><br>${t}</td>`;
            document.getElementById('texteBilan').value = "";
            saveData();
        }

        function processValidation() {
            const d = document.getElementById('newDate').value;
            const cid = document.getElementById('newComp').value;
            if(!d || !cid) return;
            const target = document.getElementById('date-' + cid);
            target.innerText = new Date(d).toLocaleDateString('fr-FR');
            target.style.background = "var(--soma-matcha)";
            saveData();
        }

        function resetAll() { if(confirm("Effacer ?")) { localStorage.clear(); location.reload(); } }
        
        function loadPhoto(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = document.getElementById('profilePic');
                img.src = event.target.result;
                img.style.display = 'block'; document.getElementById('picPlaceholder').style.display='none';
                saveData();
            };
            reader.readAsDataURL(e.target.files[0]);
        }

        window.onload = loadData;
    </script>
</body>
</html>
