<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Sōma Book - Ultimate Edition</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;1,400&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<!-- OCR LIBRARY -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
/* TON CSS ORIGINAL (inchangé) */
:root { --cover-bg: #E1E3E3; --page-color: #ffffff; --review-text: #5a4d44; }
body, html { margin:0;padding:0;width:100%;height:100%;font-family:'Inter',sans-serif;background:#f0f0f0;overflow:hidden;display:flex;justify-content:center;align-items:center;}

/* ... (tout ton CSS original reste identique) ... */

/* AJOUT CANVAS SCAN */
#scanCanvas{
    width:100%;
    max-height:60vh;
    border:1px solid #ddd;
    margin-bottom:15px;
}
</style>
</head>

<body>

<div class="grain"></div>
<div id="overlay" onclick="closeModals()"></div>

<div id="book-wrapper">
<div id="page-notif-area" class="notif-area"></div>

<!-- TOOLBAR -->
<div class="toolbar-top">

<!-- icones existantes -->
<div class="tool-icon" onclick="openModal('reviewPopup')">...</div>
<div class="tool-icon" onclick="document.getElementById('stickerUpload').click()">...</div>
<div class="tool-icon" onclick="openModal('formatModal')">...</div>
<div class="tool-icon" onclick="openModal('paperModal')">...</div>
<div class="tool-icon" onclick="openModal('colorModal')">...</div>

<!-- ===== ICONE SCAN AJOUTEE ===== -->
<div class="tool-icon" onclick="document.getElementById('scanInput').click()">
<svg viewBox="0 0 24 24" fill="none" stroke-width="2">
<path d="M4 7V4h3"/>
<path d="M20 7V4h-3"/>
<path d="M4 17v3h3"/>
<path d="M20 17v3h-3"/>
<rect x="7" y="7" width="10" height="10"/>
</svg>
</div>

</div>

<!-- TON HTML ORIGINAL CONTINUE NORMALEMENT -->
<!-- cover, pages, modals etc -->
<!-- (inchangé donc non réécrit ici pour lisibilité mais garde tout tel quel) -->

</div>

<!-- INPUT CAMERA SCAN -->
<input type="file" id="scanInput" accept="image/*" capture="environment" hidden onchange="handleScan(this)">

<!-- ===== MODAL PREVIEW SCAN ===== -->
<div id="scanPreviewModal" class="modal">
<canvas id="scanCanvas"></canvas>

<button class="btn-opt" onclick="insertScan()">INSERER</button>
<button class="btn-opt" onclick="runOCR()">LIRE TEXTE</button>
<button class="btn-opt" onclick="closeScanPreview()">ANNULER</button>

<div id="ocrResult" style="margin-top:10px;font-size:13px;"></div>
</div>

<script>

/* ===== VARIABLE SCAN ===== */
let scanImageData=null;

/* ===== HANDLE SCAN ===== */
function handleScan(input){
if(!input.files[0]) return;
const reader=new FileReader();
reader.onload=e=>{
const img=new Image();
img.onload=()=>processScanImage(img);
img.src=e.target.result;
};
reader.readAsDataURL(input.files[0]);
}

/* ===== TRAITEMENT DOCUMENT ===== */
function processScanImage(img){
const canvas=document.getElementById('scanCanvas');
const ctx=canvas.getContext('2d');

canvas.width=img.width;
canvas.height=img.height;
ctx.drawImage(img,0,0);

const data=ctx.getImageData(0,0,canvas.width,canvas.height);
const d=data.data;

for(let i=0;i<d.length;i+=4){
const gray=d[i]*0.3+d[i+1]*0.59+d[i+2]*0.11;
const bw=gray>140?255:0;
d[i]=bw; d[i+1]=bw; d[i+2]=bw;
}

ctx.putImageData(data,0,0);
scanImageData=canvas.toDataURL("image/png");

document.getElementById('scanPreviewModal').style.display='block';
document.getElementById('overlay').style.display='block';
}

/* ===== INSERER IMAGE ===== */
function insertScan(){
const img=`<img src="${scanImageData}" style="max-width:100%;display:block;margin:20px auto;">`;
document.querySelectorAll('.page-surface')[currentIdx].innerHTML+=img;
save();
closeScanPreview();
}

/* ===== OCR TEXTE ===== */
function runOCR(){
const box=document.getElementById('ocrResult');
box.innerHTML="Lecture du texte...";
Tesseract.recognize(scanImageData,'eng+fra').then(({data})=>{
box.innerHTML="<b>Texte :</b><br>"+data.text.replace(/\n/g,"<br>");
});
}

/* ===== FERMER ===== */
function closeScanPreview(){
document.getElementById('scanPreviewModal').style.display='none';
document.getElementById('overlay').style.display='none';
document.getElementById('ocrResult').innerHTML="";
}

</script>

</body>
</html>
