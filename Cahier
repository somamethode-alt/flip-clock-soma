<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SŌMA - Carnet de Candidatures</title>
    <style>
        :root {
            --header-bg: #E1E3E3;
            --accent: #2d3436;
        }

        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background-color: #f0f0f0; 
            margin: 0; padding: 0;
            overflow-x: hidden;
        }

        /* --- EFFET DE GRAIN (TEXTURE) --- */
        .grain {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999; opacity: 0.04;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* --- SYSTÈME DE LIVRE PHYSIQUE --- */
        #book-wrapper {
            position: relative; width: 100vw; height: 100vh;
            perspective: 2000px;
        }

        #cover {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--header-bg); z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            padding: 60px 20px; box-sizing: border-box;
            transition: transform 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: left center;
            box-shadow: inset -5px 0 10px rgba(0,0,0,0.1), 10px 0 30px rgba(0,0,0,0.2);
            cursor: pointer;
        }

        /* La tranche du livre */
        #cover::after {
            content: ""; position: absolute; left: 0; top: 0; width: 15px; height: 100%;
            background: rgba(0,0,0,0.05); border-right: 1px solid rgba(0,0,0,0.1);
        }

        #cover.opened { transform: rotateY(-115deg); }

        /* Contenu Couverture */
        .cover-title { font-size: 40px; letter-spacing: 8px; font-weight: 300; text-transform: uppercase; text-align: center; margin-top: 10vh; }
        .user-info { margin-top: auto; width: 300px; text-align: center; }
        .user-info input { 
            border: none; border-bottom: 1px solid var(--accent); 
            background: transparent; width: 100%; padding: 10px; 
            text-align: center; font-size: 16px; font-family: inherit;
        }
        .footer-logo { font-size: 24px; letter-spacing: 5px; font-weight: 400; margin-top: 50px; }
        .turn-page-hint { position: absolute; right: 40px; bottom: 50%; transform: translateY(50%); writing-mode: vertical-rl; text-transform: uppercase; font-size: 10px; letter-spacing: 2px; opacity: 0.5; }

        /* --- PAGE INTÉRIEURE (TABLEAU) --- */
        #main-content { padding: 40px 20px; min-height: 100vh; background: #f8f9fa; }
        .header-main h1 { letter-spacing: 3px; font-weight: 300; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .dashboard-grid { display: flex; gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; flex: 1; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        
        /* Palette */
        .palette-grid { 
            display: grid; grid-template-columns: repeat(10, 1fr); gap: 8px; 
            background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; width: fit-content;
        }
        .color-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 1px solid #eee; }

        .table-container { background: white; border-radius: 12px; overflow-x: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 1100px; }
        thead { background-color: var(--header-bg); transition: background 0.3s; }
        th { padding: 15px; text-align: left; font-size: 11px; text-transform: uppercase; }
        td { padding: 12px 15px; border-bottom: 1px solid #f1f2f6; }
        input[type="text"], input[type="date"], select { background: transparent; border: 1px solid #eee; padding: 8px; border-radius: 4px; width: 100%; font-family: inherit; }
        
        .btn-action { background: var(--accent); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; text-transform: uppercase; font-size: 10px;}
        .btn-calendar { background: #74b9ff; margin-top: 5px; width: 100%; }

        @media print { .grain, .palette-grid, .btn-action, #cover { display: none; } }
    </style>
</head>
<body id="mainBody">

    <div class="grain"></div>

    <div id="book-wrapper">
        <div id="cover" onclick="toggleBook(event)">
            <div class="cover-title">Suivi de candidature</div>
            
            <div class="user-info" onclick="event.stopPropagation()">
                <input type="text" id="userName" placeholder="PRÉNOM ET NOM" oninput="saveUserName(this.value)">
            </div>

            <div class="turn-page-hint">Tourner la page →</div>
            <div class="footer-logo">SŌMA</div>
        </div>

        <div id="main-content">
            <div class="header-main">
                <h1>SŌMA - Tableau de bord</h1>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card"><span id="totalCount" style="font-size:24px; font-weight:bold;">0</span><br><small>TOTAL ENVOYÉES</small></div>
                <div class="stat-card"><span id="relanceCount" style="font-size:24px; font-weight:bold; color:#e74c3c">0</span><br><small>À RELANCER</small></div>
                <div class="stat-card"><span id="ouiCount" style="font-size:24px; font-weight:bold; color:#27ae60">0</span><br><small>RÉPONSES OUI</small></div>
            </div>

            <div class="palette-grid" id="palette"></div>

            <button class="btn-action" onclick="addRow()">+ Ajouter une ligne</button>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Établissement / Adresse</th>
                            <th>Type d'établissement</th>
                            <th>Date d'envoi</th>
                            <th>Mode</th>
                            <th>Relance (J+10)</th>
                            <th>Statut</th>
                            <th>Réponse</th>
                            <th>Agenda</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const pastelColors = [
            "#E1E3E3", "#DFD8D5", "#D8D5D2", "#E6D4C4", "#BAB1B0", "#898684", "#F2F8F8", "#C3CED1", "#B1A6A6", "#B0AEB4",
            "#A2A09A", "#6F6869", "#E8E7E7", "#EEE9E9", "#D5C7B3", "#E2D7D4", "#B0A19F", "#C09D89", "#D0CFCD", "#E9F0F0",
            "#E4DDD4", "#B1B6AF", "#D7D8D2", "#B6AD9E", "#DFE5E5", "#E4E9EC", "#B8BFBA", "#8F877F", "#859A9E", "#BDD2E0",
            "#F8FCFD", "#E9EDEE", "#CFCFD4", "#E2DFD7", "#E2D5D5", "#DED0C7", "#F6F2F0", "#D4C1BA", "#D0C9CB", "#C1B2B1"
        ];

        let candidatures = JSON.parse(localStorage.getItem('soma_candidatures_v6')) || [];

        function toggleBook(e) {
            // Empêche l'ouverture si on clique sur l'input du nom
            if(e.target.tagName === "INPUT") return;
            document.getElementById('cover').classList.toggle('opened');
        }

        function saveUserName(val) { localStorage.setItem('soma_user_name', val); }

        // Génération de la palette (Modifie Couverture + En-tête Tableau)
        const paletteContainer = document.getElementById('palette');
        pastelColors.forEach(color => {
            const div = document.createElement('div');
            div.className = 'color-dot';
            div.style.background = color;
            div.onclick = () => {
                document.documentElement.style.setProperty('--header-bg', color);
                localStorage.setItem('soma_theme_color', color);
            };
            paletteContainer.appendChild(div);
        });

        function addRow() {
            candidatures.push({ id: Date.now(), nom: "", type: "", date: "", mode: "Mail", reponse: "Attente" });
            render();
        }

        function render() {
            const body = document.getElementById('tableBody');
            body.innerHTML = "";
            let relanceNb = 0; let ouiNb = 0;

            candidatures.forEach((c, index) => {
                const dateRelance = calculateRelance(c.date);
                const isLate = checkLate(dateRelance) && c.reponse === "Attente";
                if(c.reponse === "Oui") ouiNb++;
                if(isLate) relanceNb++;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" value="${c.nom}" oninput="update(${index}, 'nom', this.value)" placeholder="Adresse..."></td>
                    <td><input type="text" value="${c.type}" oninput="update(${index}, 'type', this.value)" placeholder="Type..."></td>
                    <td><input type="date" value="${c.date}" onchange="update(${index}, 'date', this.value)"></td>
                    <td>
                        <select onchange="update(${index}, 'mode', this.value)">
                            <option ${c.mode==='Mail'?'selected':''}>Mail</option>
                            <option ${c.mode==='Courrier'?'selected':''}>Courrier</option>
                            <option ${c.mode==='Main Propre'?'selected':''}>Main Propre</option>
                        </select>
                    </td>
                    <td>${dateRelance}</td>
                    <td style="color:${isLate ? '#e74c3c' : 'inherit'}">${isLate ? 'À RELANCER' : 'En attente'}</td>
                    <td>
                        <select onchange="update(${index}, 'reponse', this.value)">
                            <option value="Attente" ${c.reponse==='Attente'?'selected':''}>En attente</option>
                            <option value="Oui" ${c.reponse==='Oui'?'selected':''}>OUI</option>
                            <option value="Non" ${c.reponse==='Non'?'selected':''}>NON</option>
                        </select>
                    </td>
                    <td><button class="btn-action btn-calendar" onclick="addToCalendar('${c.nom}', '${dateRelance}')">Agenda</button></td>
                `;
                body.appendChild(row);
            });
            document.getElementById('totalCount').innerText = candidatures.length;
            document.getElementById('ouiCount').innerText = ouiNb;
            document.getElementById('relanceCount').innerText = relanceNb;
        }

        function update(i, k, v) { 
            candidatures[i][k] = v; 
            localStorage.setItem('soma_candidatures_v6', JSON.stringify(candidatures));
            // On ne rafraîchit pas tout le DOM ici pour garder le focus clavier
            let relanceNb = 0; let ouiNb = 0;
            candidatures.forEach(c => {
                const dr = calculateRelance(c.date);
                if(c.reponse === "Oui") ouiNb++;
                if(checkLate(dr) && c.reponse === "Attente") relanceNb++;
            });
            document.getElementById('totalCount').innerText = candidatures.length;
            document.getElementById('ouiCount').innerText = ouiNb;
            document.getElementById('relanceCount').innerText = relanceNb;
        }

        function calculateRelance(d) {
            if(!d) return "-";
            let date = new Date(d);
            date.setDate(date.getDate() + 10);
            return date.toLocaleDateString('fr-FR');
        }

        function checkLate(dateStr) {
            if(dateStr === "-") return false;
            const p = dateStr.split('/');
            return new Date() > new Date(p[2], p[1]-1, p[0]);
        }

        function addToCalendar(nom, d) {
            if(d === "-") return;
            const p = d.split('/');
            const dateStr = `${p[2]}${p[1]}${p[0]}T090000Z`;
            const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nSUMMARY:Relance Stage : ${nom}\nDTSTART:${dateStr}\nDTEND:${dateStr}\nEND:VEVENT\nEND:VCALENDAR`;
            const blob = new Blob([ics], {type: 'text/calendar'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'relance.ics'; a.click();
        }

        // Initialisation
        const savedColor = localStorage.getItem('soma_theme_color');
        if(savedColor) document.documentElement.style.setProperty('--header-bg', savedColor);
        const savedName = localStorage.getItem('soma_user_name');
        if(savedName) document.getElementById('userName').value = savedName;
        render();
    </script>
</body>
</html>
